# LogInsight 日志分析器总结文档

## 1. 环境准备
- **操作系统**: Windows 11 (推荐使用 Windows Terminal 以获得最佳显示效果)
- **开发工具**: Rust 编译器 (rustc/cargo 1.75+)
- **系统组件**: 需要访问系统剪贴板权限 (用于 `arboard` 库)

## 2. 编译与运行
在项目根目录下使用 PowerShell 执行：

```powershell
# 编译项目
cargo build --release

# 运行 (默认读取当前目录下的 AisEsmEmc.log)
cargo run

# 运行 (指定日志文件路径)
cargo run -- "C:\path\to\your_service.log"
```

## 3. 核心功能特性
- **智能转码**: 自动识别并转换 GB18030 编码（中文），并对日志内嵌的 UTF-8 JSON 字符串进行二次解码修复。
- **多行合并**: 自动识别跨行打印的 JSON 结构，并将其还原为单条结构化记录。
- **噪声折叠**: 自动识别并合并连续的 USB 轮询、线程清理及完全重复的日志行，大幅提升阅读效率。
- **性能分析**: 
    - **Delta Time**: 自动计算同线程相邻日志的时间差。
    - **卡顿高亮**: 耗时 >100ms 显示黄色 `[+100ms]`，>1s 显示红色 `[SLOW]`。
- **可视化统计**: 底部直方图实时展示每分钟日志生成频率，快速定位系统繁忙时段。
    - **柱状图数字**: 该分钟内产生的日志条数
    - **柱状图下方**: 时间戳（格式：月-日 时:分，如 `01-04 17:35` 表示1月4日17点35分）
    - **顶部统计**: `总计:N` 为日志总数；`Peak: N @ MM-DD HH:MM` 为峰值及其时间
    - **颜色含义**: 🟥红色 >100条 | 🟨黄色 >50条 | 🟦青色 ≤50条（正常）

## 4. 交互操作快捷键
| 按键 | 类别 | 功能描述 |
| :--- | :--- | :--- |
| `↑` / `↓` | 导航 | 向上/向下选择日志条目 |
| `k` / `j` | 导航 | (Vim 风格) 向上/向下选择 |
| `/` | 搜索 | 进入正则表达式搜索模式 |
| `Enter` | 搜索 | (搜索模式下) 确认关键词并搜索 |
| `n` / `N` | 搜索 | 跳转到下一个/上一个搜索匹配项 |
| `t` | 过滤 | 开启/关闭选中行所属线程 (TID) 的专属过滤模式 |
| `a` | AI诊断 | 调用本地 Ollama AI 分析当前选中行±10行上下文 |
| `c` | 导出 | 复制当前选中行的完整原始文本到系统剪贴板 |
| `y` | 导出 | 复制当前行的 JSON Payload (Pretty Print) 到剪贴板 |
| `Esc` | 状态 | 退出搜索模式 / 关闭AI弹窗 / 清除线程过滤状态 |
| `q` | 系统 | 退出程序 |

## 5. AI 诊断功能
- **依赖**: 需要本地运行 [Ollama](https://ollama.ai/) 服务 (`ollama serve`)
- **模型**: 默认使用 `qwen2.5-coder:7b`，首次使用需 `ollama pull qwen2.5-coder:7b`
- **使用**: 选中日志行后按 `a` 键，AI 将分析日志上下文并给出诊断建议

## 6. 常见问题排查
- **乱码问题**: 若在 PowerShell 中看到乱码，请确保使用 `Windows Terminal`，其对 UTF-8 支持更佳。
- **按键无效**: 避免在 Cursor 或 IDE 的集成终端中运行 TUI 程序，建议使用独立终端。
- **文件占用**: 若编译报错 `拒绝访问 (os error 5)`，请确保没有正在运行的 `log_analysis` 实例。

